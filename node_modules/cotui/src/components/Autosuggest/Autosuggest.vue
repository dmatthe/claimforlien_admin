<template>
    <div class="typeahead" cotui>
        <label :id="`${id}__label`" :for="`${id}__input`" class="typeahead__label">{{label}}</label>
        <div class="typeahead__wrapper">
            <div role="combobox"
                :aria-expanded="isExpanded"
                aria-owns="typeahead__results"
                aria-haspopup="listbox"
                :id="`${id}__combobox`"
                class="input-group input-group-lg"
                >
                <input type="text"
                    v-model="query"
                    @blur="handleBlur"
                    @change="handleChange"
                    @keyup="handleKeydown"
                    autocomplete="off"
                    aria-autocomplete="off"
                    aria-controls="typeahead__results"
                    :aria-labelledby="`${id}__label`"
                    class="typeahead__input form-control"
                    :data-value="queryID"
                    :list="`${id}__results`"
                    :id="`${id}__input`">
                <div class="input-group-btn">
                  <button
                      v-show="query"
                      class="button--clear btn btn-defaut"
                      @click="onClear"
                      :id="`${id}__button--clear`"
                      tabindex="0"
                      role="button"
                      type="button"
                      aria-label="Clear textbox">
                      <i class="fas fa-times-circle"></i>
                  </button>
                  <button class="btn btn-primary"
                      :id="`${id}__button--submit`"
                      type="button"
                      @click.stop.prevent="submit"
                      >
                      {{button}}
                  </button>
              </div>
            </div>
            <ul
                :hidden="!isExpanded"
                role="listbox"
                :aria-labelledby="`${id}__label`"
                :id="`${id}__results`"
                class="typeahead__results list-group">
                <li v-for="(result,ndx) in results" :key="ndx"
                    role="option"
                    @click="onSelect(ndx)"
                    :class="['typeahead__result',{'focus':resultIndex==ndx},'list-group-item']"
                    :id="`${id}__result--${ndx}`"
                    :aria-selected="(resultIndex==ndx)?true:false"
                    :data-id="result.value"
                >
                    <i v-if="icon" :class="icon"></i> {{result.text}}
                </li>
            </ul>
        </div>
    </div>
</template>

<style lang="scss">
[cotui]{
.typeahead__wrapper{
  position: relative;
}


.typeahead__results{
  position: absolute;
  top: 44px;
  width: 100%;
  z-index: 1000;

  -webkit-box-shadow: 1px 3px 3px 0px rgba(0,0,0,0.19);
  -moz-box-shadow: 1px 3px 3px 0px rgba(0,0,0,0.19);
  box-shadow: 1px 3px 3px 0px rgba(0,0,0,0.19);
}
.input__button--clear{
  background: #fff;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;

  -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
  -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
  box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
}
.typeahead__result{
 color: #ccc;

 &:hover{
   color: #333;
   cursor: pointer;
 }
 &.focus{
   font-weight: 500;
   color: #333;
 }
}

.button--clear{
  border: 1px solid #ccc;
  border-left: none;
  -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
  -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
  box-shadow: inset 0 1px 1px rgba(0,0,0,.075);

  border-radius: none;

  }
}
</style>

<script>
  import * as COMMON from 'common';

  export default{
      name:'cotui-autosuggest',
      inheritAttrs: false,
      components:{},
      watch:{
          results:function(val){
            if(this.autoSelect && (val.length > 0)){
              this.resultIndex = 0;
              this.queryID = val[this.resultIndex].value;
            }
          }
      },
      props: {
        label:{
          type:String,
          default:'Look up value'
        },
        button:{
          type:String,
          default:'Lookup'
        },
        icon:{
          type:String
        },
        type: {
          String,
          default:'default'
        },
        onSelected: [Function, String],
        onResults: [Function, String],
        onSearch: [Function, String],
        onSubmit: [Function, String],
      },
      data(){
        let api = {}
        if(this.$attrs['data-api.url']){
          const API_URL = this.$attrs['data-api.url']||this.$attrs.url||'';
          const API_VALUE = this.$attrs['data-api.attr-value']||'';
          const API_TEXT = this.$attrs['data-api.attr-text'||''];
          const API_PATH = this.$attrs['data-api.attr-array']||'';
          const API_PARAMS = this.$attrs['data-api.url-params']||'';
          const API_INCLUDEALL = this.$attrs['data-api.includeall']||false;

          api = {
              url: API_URL,
              value: API_VALUE,
              text: API_TEXT,
              path: API_PATH,
              params: API_PARAMS,
              includeAll: API_INCLUDEALL
            }
        } else {
          api = this.$attrs.dataApi
        }

          return{
            id:'',
            autoSelect: true,
            resultIndex: -1,
            isExpanded: false,
            query: '',
            queryID: '',
            result:{},
            results:[],
            maxResults: this.$attrs['limit']||7,
            data: this.data||this.$attrs.data,
            dataApi: api
          }
      },
      beforeCreate(){

      },
      beforeMount(){
        this.ariaLiveId = COMMON.CONSTANTS.ARIA_LIVE_ID
        this.hasAriaLive = document.getElementById(this.ariaLiveId)
        if(!this.hasAriaLive){
          const ariaLive = document.createElement('div')
                ariaLive.setAttribute('id',this.ariaLiveId)
                ariaLive.setAttribute('role','status')
                ariaLive.setAttribute('aria-live','polite')


          document.body.appendChild(ariaLive);
        }

        this.id = `js-${COMMON.utils.generateID()}`
      },
      created(){
        var ulData = [];
        if( this.$slots.default  ){
          this.$slots.default[0].children.map(els=>{
            if(els.children){
              let $text = '';
              let $value = '';

              $text = els.children[0].text
              if(els.data){
                $value = 'data-value' in els.data.attrs?els.data.attrs['data-value']:'undefined: "data-value" Missing'
              } else {
                $value = $text
              }
              ulData.push({text: $text,value: $value})
            }
          })
          this.data = ulData
        }
      },
      computed:{},
      methods:{
          onClear:function(){
            this.query = '';
            this.queryID = '';

          },
          onSelect:function(ndx){
            if( this.results.length>0){
              this.resultIndex = ndx;
              this.query = this.results[this.resultIndex].text;
              this.queryID = this.results[ndx].value;


              if(this.onSelected) {
                if(typeof(this.onSelected) === 'string'){
                  const strFunc = new Function("return " + this.onSelected)();
                  strFunc({text:this.query, index:ndx, result:this.results[ndx]})
                } else{
                  this.onSelected({text:this.query, index:ndx, result:this.results[ndx]})
                }
              }

              this.$emit('onSelect', this.results[ndx])
            }
            this.isExpanded = false;
          },
          submit:function(evt){
            if(this.query && this.results.length > 0){
              this.query = this.results[this.resultIndex].text;
              this.queryID = this.results[this.resultIndex].value;
              this.result = this.results[this.resultIndex];
              this.results = [];


              if(this.onSubmit) {
                if(typeof(this.onSubmit) === 'string'){
                  const strFunc = new Function("return " + this.onSubmit)();
                  strFunc({text:this.query, value:this.queryID, result:this.result})
                } else{
                  this.onSubmit({text:this.query, value:this.queryID, result:this.result})
                }
              }

              this.$emit('onSubmit', {text:this.query, value:this.queryID, result:this.result})
            }
            this.isExpanded = false;
          },
          handleBlur:function(){
            setTimeout(()=>{
              this.isExpanded = false
            }, 100)
          },
          handleSearch:function(){
            const type = this.type;
            const query = this.query;
            const searchIntersection = this.excludeIntersection?1:0;
            const maxResults = this.maxResults
            const dataApi = this.dataApi;
            
            const promise = new Promise((resolve,reject)=>{
              

              /*
               * API Search
               */
              if( type === 'api'){
                const apiRequest = COMMON.utils.getJSON(dataApi.url.replace(/(\{QUERY\})/gi,query)).then(function(api){
                  var apiResult = []
                  const get = (p, o) => p.reduce((xs, x) => (xs && xs[x]) ? xs[x] : null ,o)
                  const dataSrcPath = get( dataApi.path.split('\.'), api )
                  const dataLabel = dataApi.text;

                  if(dataSrcPath){
                    dataSrcPath.map((res,ndx)=>{
                      if(apiResult.length < maxResults)
                      apiResult.push({text:res[dataApi.text], value:res[dataApi.value], data: dataApi.includeAll?res:''})
                    })
                  }
                  return apiResult
                })
                resolve(apiRequest)
              }

              /*
               * SEARCH JSON.OBJECT|JSON.FILE 
               */
              if(type=='json'){
                var jsonResults = []
                if(typeof(dataApi.url) == 'string'){
                  this.data = COMMON.utils.getJSON(dataApi.url);
                } else {
                  this.data = dataApi.url
                }

                const id = '';
                const keys = dataApi.text.split(',');
                const Fuse = require('fuse.js');
                const options = { 
                  shouldSort: true,
                  matchAllTokens: true,
                  threshold: 0.1,
                  location: 0,
                  distance: 100,
                  maxPatternLength: 32,
                  minMatchCharLength: 1,
                  keys, 
                  id 
                }
                
                if(query != ''){
                  const search = new Fuse(this.data,options).search(query)
                  search.map((res)=>{
                    jsonResults.push({
                      text: res[dataApi.value],
                      value:res[dataApi.value],
                      data:res
                    })
                  })
                  resolve(jsonResults)
                }

              }

              

              /*
               * Use Built-in Search Method
               */
              if(type ==='default'){
                var filterResults =[];
                var builtInResults = [];
 
                const regex = new RegExp(`${query}`,'gi');
                filterResults = this.data.filter(term=>{
                  if('value' in term){
                    return term.text.match(regex);
                  } else {
                    term.value = term.text;
                    return term.text.match(regex);
                  }
                });

                filterResults.map((term,ndx)=>{
                  if(ndx < maxResults){
                    builtInResults.push(term)
                  }
                })
                resolve(builtInResults)
              }



              /*
               * Use Custom Search Method
               * must pass object ({query:'', data:[]})
               * must return []
               */
              if(type==='custom'){
                var customResults = []
                if(this.onSearch) {
                  if(typeof(this.onSearch) === 'string'){
                    const strFunc = new Function("return " + this.onSearch)();
                    customResults = strFunc({text:this.query})
                  } else{
                    customResults = this.onSearch({text:this.query})
                  }
                }
                resolve(customResults)
              }

              
            })

            /*
             *  Custom results handler
             */
            promise.then((res)=>{
              if(this.onResults) {
                if(typeof(this.onResults) === 'string'){
                  const strFunc = new Function("return " + this.onResults)();
                  strFunc({text:this.query, result:res})
                } else{
                  this.onResults({text:this.query, result:res})
                }
              }

              this.$emit('onResults', res)
            })

            /*
             *  Update ARIA
             */
            promise.then((res)=>{
              if(res.length > 0){
                COMMON.utils.updateAriaLive(`${res.length} items contain ${this.query}. The first item is ${res[0].text}. The last item is${res[res.length-1].text}`)
              }
            })

            this.$emit('onSearch', promise)
            return promise
          },
          handleChange:function(evt){},
          handleKeydown:function(evt){
              switch(evt.keyCode){
                  case 40:
                      if( (this.results.length > 0) && (this.resultIndex < this.results.length-1) ){
                        this.resultIndex++;
                        this.query = this.results[this.resultIndex].text;
                      }
                  break;

                  case 38:
                      if( (this.resultIndex > -1) && (this.results.length > 0) && (this.resultIndex > 0) ){
                        this.resultIndex--;
                        this.query = this.results[this.resultIndex].text
                      }
                  break;

                  case 13:
                      this.onSelect(this.resultIndex)
                  break;

                  default:
                    if(/^(\s)$|(^$)/.test(this.query)){
                      this.result = {};
                      this.results = []
                      this.isExpanded = false;
                    } else if ( !( (evt.keyCode == 39) || (evt.keyCode == 37) ) ){
                      this.result = {};
                      this.isExpanded = true;
                      this.handleSearch().then((res)=>{
                        this.results = res
                      })
                    }
                  break;
              }
          }
      }
  }
</script>
