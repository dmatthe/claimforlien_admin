"use strict";var cot_map=function(e,t){this.container=e;t.enableControlBox&&(t.enableControlBox=$.extend({position:"bottomright",width:300},t.enableControlBox||{})),t.enableFullscreen&&(t.enableFullscreen=$.extend({options:{position:"topleft",title:"See the map in fullscreen",titleCancel:"Exit fullscreen mode",content:'<span class="glyphicon glyphicon-fullscreen"></span>',forceSeparateButton:!1,forcePseudoFullscreen:!1,fullscreenElement:!1},enterFullscreen:function(){},exitFullscreen:function(){}},t.enableFullscreen||{})),t.enableSearchBar&&(t.enableSearchBar=$.extend({position:"topright",url:"https://map.toronto.ca/cotgeocoder/rest/geocoder",width:300,maxSuggest:10},t.enableSearchBar||{})),t.enableWardSelection&&(t.enableWardSelection=$.extend({position:"topright",width:300,url:"https://services3.arcgis.com/b9WvedVPoizGfvfD/arcgis/rest/services/COTGEO_CITY_WARD/FeatureServer/0",html:'<div class="wardsdiv"><label class="sr-only" for="wardSelect" id="wardselectTitle">Select a Ward</label><select class="form-control ward_number" id="wardSelect" disabled>  <option value="0">Select a Ward </option></select><button class="btn btn-default" type="button">  <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>  <span class="sr-only">Reset the wards selection</span></button>  </div>',onWardSelect:function(){},onWardUnselect:function(){},dropdownField:"AREA_DESC",style:{color:"rgba(23, 86, 137, 0.5)",fill:"rgba(23, 86, 137, 0.5)",fillOpacity:1,weight:4}},t.enableWardSelection||{})),this.options=$.extend({mapCenter:[43.66,-79.373903],maxBounds:[[43.39,-80.29],[44,-78.6]],zoom:12,mapType:"Topographic",mapHeight:400,isVectorBasemap:!1},t||{}),this.map=null,this.featureLayerList={},this.markerList={defaultLayer:L.layerGroup()}};cot_map.prototype.render=function(){var e={zoom:this.options.zoom,center:this.options.mapCenter,mapTypeId:this.options.mapType,mapHeight:this.options.mapHeight,enableControlBox:this.options.enableControlBox,enableFullscreen:this.options.enableFullscreen,enableSearchBar:this.options.enableSearchBar,enableWardSelection:this.options.enableWardSelection};$("#"+this.container).css("height",this.options.mapHeight),this.map=L.map(this.container),this.options.isVectorBasemap?L.esri.Vector.basemap(e.mapTypeId).addTo(this.map):L.esri.basemapLayer(e.mapTypeId).addTo(this.map),this.map.options.minZoom=10,this.map.options.maxZoom=18,this.map.setMaxBounds(this.options.maxBounds),this.map.setView(e.center,e.zoom);var t=this.map,a=$("#"+this.container);if(a.delegate(".leaflet-control","mouseout",function(){t.dragging.enable()}).delegate(".leaflet-control","mouseover",function(){t.dragging.disable()}),e.enableControlBox){var r=L.control({position:e.enableControlBox.position});r.onAdd=function(t){var a=L.DomUtil.create("div","map-legend--fl",L.DomUtil.get("map"));return a.style.width=e.enableControlBox.width+"px",a},r.addTo(this.map),L.DomEvent.disableClickPropagation(r._container).disableScrollPropagation(r._container),featLay=this.featureLayerList,t=this.map,$(".map-legend--fl").addClass("hidden").html('<div class="map-legend--fl__title">Control</div><div class="map-legend--fl__content hidden-xs" />').delegate(".js-fl_control","change",function(){0==$(this).prop("checked")?t.removeLayer(featLay[$(this).attr("id")].fl):t.addLayer(featLay[$(this).attr("id")].fl)}),$(".map-legend--fl__title").on("click",function(){var e=$(".map-legend--fl__content");e.hasClass("hidden-xs")?e.removeClass("hidden-xs").addClass("visible-xs-*"):e.removeClass("visible-xs-*").addClass("hidden-xs")})}if(e.enableFullscreen){L.control.fullscreen(e.enableFullscreen.options).addTo(this.map);this.map.on("enterFullscreen",function(){e.enableFullscreen.enterFullscreen()}),this.map.on("exitFullscreen",function(){e.enableFullscreen.exitFullscreen()})}if(e.enableSearchBar){var n=function(t){var a=e.enableSearchBar.url+"/suggest",r=$.Deferred(),n={f:"json",addressOnly:0,retRowLimit:e.enableSearchBar.maxSuggest,searchString:t};return $.ajax({method:"GET",url:a+"?"+$.param(n),type:"GET",contentType:"application/json",dataType:"json"}).done(function(e){r.resolve(e.result.rows)}).fail(function(){r.resolve([])}),r.promise()},o=function(e){var t=$("#searchTerm").val().trim();if(t.length<4)return $("#resultsListbox").html("<li />"),$("#resultsListbox li, .js-aria-live").html("Your search term must have at least 4  characters"),e?($("#searchResults").addClass("hidden"),$("#searchTermWrapper").attr("aria-expanded",!1)):c(),!1;c(),$.when(n(t)).done(function(e){if(0==(u=e.length))$("#resultsListbox").html("<li />"),$("#resultsListbox, .js-aria-live").html("No location found");else{var a="";$.each(e,function(e,r){a+='<li class="searchResultsList" role="option" id="res'+r.KEYSTRING.replace(":","-")+'">',a+='<button type="button" tabindex="-1" class="js-getLocationAndDisplay resultbutton btn btn-link" data-keystring="'+r.KEYSTRING+'">'+r.ADDRESS.replace(new RegExp("("+t+")","i"),'<span class="hlgt">$1</span>')+"</button>",a+="</li>"}),$("#resultsListbox").html(a),$(".js-aria-live").html(u+' Results are available for "'+t+'", use up and down arrows to review and enter to select. Touch device users, explore by touch or with swipe gestures.')}})},s=function(){var e=$(".resultbutton").index($(".isActive"));e--,e<0&&(e=u-1),$(".resultbutton").removeClass("isActive");var t=$(".resultbutton").eq(e).text(),a=$(".searchResultsList").eq(e).attr("id");$(".resultbutton").eq(e).addClass("isActive"),$("#searchTerm").val(t).attr("aria-activedescendant",a)},i=function(){var e=$(".resultbutton").index($(".isActive"));(++e<=0||e>=u)&&(e=0);var t=$(".resultbutton").eq(e).text(),a=$(".searchResultsList").eq(e).attr("id");$(".resultbutton").removeClass("isActive"),$(".resultbutton").eq(e).addClass("isActive"),$("#searchTerm").val(t).attr("aria-activedescendant",a)},l=function(){keepFocus||($("#searchResults").addClass("hidden"),$("#searchTermWrapper").attr("aria-expanded",!1))},c=function(){keepFocus=!0,$("#searchResults").removeClass("hidden"),$("#searchTermWrapper").attr("aria-expanded",!0)};a.delegate(".js-getLocationAndDisplay","click",function(a){var r=$(this),n=r.data("keystring"),o=e.enableSearchBar.url+"/findAddressCandidates",s={f:"json",keyString:n,retRowLimit:10};return $.ajax({url:o+"?"+$.param(s),type:"GET",contentType:"application/json",dataType:"json"}).done(function(e){1==e.result.rows.length&&(t.setView([e.result.rows[0].LATITUDE,e.result.rows[0].LONGITUDE],16),L.popup().setLatLng([e.result.rows[0].LATITUDE,e.result.rows[0].LONGITUDE]).setContent(e.result.rows[0].KEY_DESC).openOn(t),$("#searchTerm").val(e.result.rows[0].KEY_DESC),$("#searchResults").addClass("hidden"),$("#searchTermWrapper").attr("aria-expanded",!1),$(".leaflet-popup-close-button").focus(),$(".searchMobileOpen").removeClass("searchMobileOpen").removeClass("legendOpen"))}),!1});var d=L.control({position:e.enableSearchBar.position});d.onAdd=function(t){var a=L.DomUtil.create("div","map-legend--searchBar searchBar",L.DomUtil.get("map"));return a.style.width=e.enableSearchBar.width+"px",a},d.addTo(this.map),L.DomEvent.disableClickPropagation(d._container).disableScrollPropagation(d._container);var u=0,p="";p+='<div role="search" id="'+this.container+'_search" aria-label="Address Search">',p+='<div class="input-group input-group-md">',p+='<label class="sr-only" id="searchMapTitle" for="searchTerm">Search for an address or an Intersection</label><div aria-owns="resultsListbox" role="combobox" aria-haspopup="listbox" aria-expanded="false" id="searchTermWrapper"><input type="text" name="searchTerm" id="searchTerm" placeholder="search address/intersection" class="form-control" spellcheck="false" autocomplete="off" aria-controls="resultsListbox" aria-autocomplete="list"></div>',p+='<div class="input-group-btn">',p+='<button type="button" class="btn btn-primary" id="searchButton"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="label-icon sr-only">Find Location</span></button>',p+="</div>",p+="</div>",p+="</div>",p+='<div id="searchResults" class="searchResults hidden"><h5 id="searchResultsTitle">Address Search Results</h5><ul aria-labelledby="searchResultsTitle"  role="listbox" id="resultsListbox"></ul></div>',$(".map-legend--searchBar").html(p),$("#"+this.container+"_search").on("keydown",function(e){if(13==e.keyCode)return e.preventDefault(),o(),!1}).find("#searchButton").on("click",o);var h=null;$("#"+this.container+"_search").delegate(".resultbutton","mousemove",function(){$(".resultbutton").removeClass("isActive")}),$("#searchTerm").on("keydown",function(e){switch(e.keyCode){case 220:e.preventDefault();break;case 37:case 39:break;case 38:0==$(".searchResults.hidden").length&&s(),e.preventDefault();break;case 9:break;case 27:keepFocus=!1,l(),$("#searchTerm").val("").attr("aria-activedescendant",""),e.preventDefault();break;case 40:0==$(".searchResults.hidden").length&&i(),e.preventDefault();break;case 13:0==$(".searchResults.hidden").length?($(".resultbutton.isActive").trigger("click"),$("#searchTerm").attr("aria-activedescendant","")):(window.clearTimeout(h),h=window.setTimeout(function(){o()},500)),e.preventDefault();break;case 8:default:window.clearTimeout(h),h=window.setTimeout(function(){o(!0)},500)}}).on("blur",function(){window.clearTimeout(h),keepFocus=!1,window.setTimeout(function(){l(),$("#searchTerm").val("").attr("aria-activedescendant","")},200)}).on("focus",function(){o(!0)}),$(".searchResults").on("focus",function(){c()}).on("blur",function(){window.clearTimeout(h),keepFocus=!1,window.setTimeout(l,200)}),$("#searchButton").on("keydown",function(e){switch(e.keyCode){case 9:(0==$(".searchResults.hidden").length||e.shiftKey)&&(e.preventDefault(),$("#searchTerm").focus());break;case 13:case 32:$("#searchTerm").focus();break;case 27:keepFocus=!1,l(),e.preventDefault();break;default:e.preventDefault()}}).on("click",function(){window.clearTimeout(h),h=window.setTimeout(function(){o()},500)})}if(e.enableWardSelection){var m={},f=L.control({position:e.enableWardSelection.position});f.onAdd=function(t){var a=L.DomUtil.create("div","map-legend--wardsBar wardsBar",L.DomUtil.get("map"));return a.style.width=e.enableWardSelection.width+"px",a.innerHTML=e.enableWardSelection.html,a},f.addTo(t),L.DomEvent.disableClickPropagation(f._container).disableScrollPropagation(f._container),t.createPane("allWards"),$(".wardsdiv").delegate(".ward_number","change",function(){var a=$(this).val();for(var r in m)m[r].fl.removeFrom(t);if(0!=a){$(".wardsdiv").addClass("resetOn");var n=m[a].fl.getBounds();t.flyToBounds(n),m[a].fl.addTo(t),"function"==typeof e.enableWardSelection.onWardSelect&&e.enableWardSelection.onWardSelect(m[a]||!1)}else $(".wardsdiv").removeClass("resetOn"),"function"==typeof e.enableWardSelection.onWardUnselect&&e.enableWardSelection.onWardUnselect()}).delegate("button","click",function(){$(".ward_number").val(0).trigger("change")}),L.esri.query({url:e.enableWardSelection.url}).where("1=1").run(function(t,a){for(var r=0;r<a.features.length;r++)m[a.features[r].id]={properties:a.features[r].properties,fl:L.geoJSON(a.features[r],e.enableWardSelection.style)};if(1==$(".ward_number option").length){for(var n=Object.keys(m).sort(function(e,t){return m[e].properties.AREA_SHORT_CODE-m[t].properties.AREA_SHORT_CODE}),o=0;o<n.length;o++)$(".ward_number").append('<option value="'+n[o]+'" data-area="'+m[n[o]].properties.AREA_SHORT_CODE+'">'+m[n[o]].properties[e.enableWardSelection.dropdownField||AREA_DESC]+"</option>");$(".wardsdiv select").prop("disabled",!1)}})}},cot_map.prototype.addMarker=function(e){if(e=$.extend({addToLayer:"defaultLayer",title:"Please give that Marker a name",description:"Please give that marker a popup description"},e||{}),!e.LatLng)return console.log("Your marker needs LatLng parameter!"),!1;var t=L.icon({iconUrl:L.Icon.Default.prototype._detectIconPath()+L.Icon.Default.prototype.options.iconUrl,iconAnchor:[12,0]});this.markerList.hasOwnProperty(e.addToLayer)||(this.markerList[e.addToLayer]=e.enableClustering?L.markerClusterGroup():L.layerGroup());var a={LatLng:e.LatLng,options:{draggable:!1,title:e.title,alt:e.title,icon:t}};L.marker(a.LatLng,a.options).bindPopup("<h3>"+e.title+"</h3><div>"+e.description+"</div>").addTo(this.markerList[e.addToLayer]),this.map.addLayer(this.markerList[e.addToLayer])},cot_map.prototype.addFeatureLayer=function(e){if(e=$.extend({title:"Give that layer a title!",enableClustering:!0,addToControlBox:!0,loadByDefault:!0,template:""},e||{}),!e.hasOwnProperty("id")||!e.hasOwnProperty("url"))return console.log("Please check your featureLayer options !"),!1;e.enableClustering?this.featureLayerList[e.id]={title:e.title,addToControlBox:e.addToControlBox,fl:L.esri.Cluster.featureLayer(e)}:this.featureLayerList[e.id]={title:e.title,addToControlBox:e.addToControlBox,fl:L.esri.featureLayer(e)},e.loadByDefault&&this.featureLayerList[e.id].fl.addTo(this.map),""!=e.template&&this.featureLayerList[e.id].fl.bindPopup(function(t){return L.Util.template(e.template,t.feature.properties)}),this.options.enableControlBox&&e.addToControlBox&&($(".map-legend--fl__content").html(""),$.each(this.featureLayerList,function(e,t){t.addToControlBox&&$(".map-legend--fl__content").append('<label class="custom-checkbox" for="'+e+'"><input type="checkbox" class="js-fl_control" name="fl_control" id="'+e+'" checked><span></span> '+t.title+"</label>")}),$(".map-legend--fl").removeClass("hidden"))},cot_map.prototype.addControl=function(e){e=$.extend({position:"topleft",className:!1,content:"<h1>PLEASE ADD A CONTENT TO YOUR CONTROLBOX !</h1>",disablePropagation:!0},e||{});var t=L.control({position:e.position});t.onAdd=function(t){var a=L.DomUtil.create("div",e.className);return a.innerHTML=e.content,a},t.addTo(this.map),e.disablePropagation&&L.DomEvent.on(t._container,"dblclick mousewheel touchstart",function(e){L.DomEvent.stopPropagation(e)})};