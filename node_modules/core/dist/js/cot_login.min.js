"use strict";var cot_login=function(o){if(this.options=$.extend({appName:"",ccRoot:"",ccPath:"",ccEndpoint:"",welcomeSelector:"",loginMessage:"",onLogin:function(o){}},o||{}),!this.options.appName)throw new Error("Error: the appName option is required");this.session=new CotSession({appName:this.options.appName,ccApiOrigin:this.options.ccRoot||void 0,ccApiPath:this.options.ccPath||void 0,ccApiEndpoint:this.options.ccEndpoint||void 0}),this._setUserName()};cot_login.prototype.showLogin=function(){var o=this;this.modal=cot_app.showModal({title:"User Login",body:this.options.loginMessage+'<form class="cot-form loginForm"><div tabindex="-1" id="loginhelp_combination" style="display:none" class="alert alert-danger"></div><div class="form-group username-group"><label for="cot_login_username" class="control-label"><span>Username</span></label><div class="entryField"><input class="form-control required" id="cot_login_username" aria-required="true"><i class="form-control-feedback glyphicon glyphicon-remove" data-fv-icon-for="username" aria-hidden="true" style="display: none;"></i></div><div id="loginhelp_username" class="fv-err-msg" style="display:none"><small class="help-block">Username is required and cannot be left blank</small></div></div><div class="form-group password-group"><label for="cot_login_password" class="control-label"><span>Password</span></label><div class="entryField"><input class="form-control required" type="password" id="cot_login_password" aria-required="true"><i class="form-control-feedback glyphicon glyphicon-remove" data-fv-icon-for="password" aria-hidden="true" style="display: none;"></i></div><div id="loginhelp_password" style="display:none" class="fv-err-msg"><small class="help-block">Password is required and cannot be left blank</small></div></div></form>',footerButtonsHtml:'<button class="btn btn-primary btn-cot-login">Login</button><button class="btn btn-default" data-dismiss="modal">Cancel</button>',originatingElement:$(this.options.welcomeSelector).find("a.login"),className:"cot-login-modal",onShown:function(){o.modal.find(".btn-cot-login").click(function(){o._login()}),o.modal.find(".modal-body input").keydown(function(s){13===(s.charCode||s.keyCode||0)&&o._login()})}})},cot_login.prototype.isLoggedIn=function(){return this.session.isLoggedIn()},cot_login.prototype.logout=function(){this.session.logout(),this._setUserName(),window.location.reload()},cot_login.prototype._setUserName=function(){this._loadSessionFields();var o=this,s=$(this.options.welcomeSelector);s.find("div.welcomemsg").remove(),this.isLoggedIn()?(s.html("<div class='welcomemsg'><b>User Name</b>: "+this.username+" (<a class='logout' href='#'>Logout</a>)</div>"),s.find("a.logout").on("click",function(){return o.logout(),!1}),this.options.onLogin(this)):(s.html("<div class='welcomemsg'><a class='login' href='#'>Login</a></div>"),s.find("a.login").on("click",function(){return o.showLogin(),!1}))},cot_login.prototype._login=function(){var o=this,s=$("#cot_login_username"),i=$("#cot_login_password"),e=s.val(),n=i.val();if($.each($(".username-group, .password-group"),function(){var o=$(this);o.removeClass("has-error"),o.find(".form-control-feedback").css("display","none").removeClass("glyphicon-ok").removeClass("glyphicon-error"),$("#loginhelp_username, #loginhelp_password, #loginhelp_combination").css("display","none"),s.removeAttr("aria-describedby"),i.removeAttr("aria-describedby"),s.removeAttr("aria-invalid"),i.removeAttr("aria-invalid")}),e?($(".username-group").addClass("has-success"),$(".username-group").find(".form-control-feedback").css("display","block").removeClass("glyphicon-remove").addClass("glyphicon-ok")):(s.focus(),$(".username-group").addClass("has-error"),$(".username-group").find(".form-control-feedback").css("display","block").addClass("glyphicon-remove").addClass("glyphicon-error"),$("#loginhelp_username").css("display","block"),s.attr("aria-describedby","loginhelp_username"),s.attr("aria-invalid","true")),n?($(".password-group").addClass("has-success"),$(".password-group").find(".form-control-feedback").css("display","block").removeClass("glyphicon-remove").addClass("glyphicon-ok")):(i.focus(),$(".password-group").addClass("has-error"),$(".password-group").find(".form-control-feedback").css("display","block").addClass("glyphicon-remove").addClass("glyphicon-error"),$("#loginhelp_password").css("display","block"),i.attr("aria-describedby","loginhelp_password"),i.attr("aria-invalid","true")),n||e||s.focus(),!n||!e)return!1;this.modal.find(".btn").prop("disabled",!0).eq(0).html("Working..."),this.session.login({username:e,password:n,success:function(){o._setUserName(),o.modal.modal("hide")},error:function(e,n,t){console.log("POST Request Failed: "+n+", "+t,arguments),"invalid_user_or_pwd"===t?(o._displayLoginError("Invalid username or password.",!1),s.attr("aria-invalid","true"),i.attr("aria-invalid","true")):o._displayLoginError("Unable to log in. Please try again."),$("#loginhelp_combination").focus()},always:function(){o.modal.find(".btn").removeAttr("disabled").removeClass("disabled").eq(0).html("Login")}})},cot_login.prototype._loadSessionFields=function(){var o=this;["sid","username","email","firstName","lastName","division","groups"].forEach(function(s){o[s]=o.session[s]})},cot_login.prototype._displayLoginError=function(o,s){s&&($("#cot_login_username").val(""),$("#cot_login_password").val("")),$.each($(".username-group, .password-group"),function(){var s=$(this);s.addClass("has-error"),s.find(".form-control-feedback").css("display","block").addClass("glyphicon-remove").addClass("glyphicon-error"),$("#loginhelp_username,#loginhelp_password").css("display","none"),$("#loginhelp_combination").css("display","block"),$("#loginhelp_combination").html("<p>"+o+"</p>")})};var CotSession=function(o){if(this.options=$.extend({appName:"",ccApiOrigin:"",ccApiPath:"/cc_sr_admin_v1/",ccApiEndpoint:"session"},o||{}),!this.options.appName)throw new Error("Error: the appName option is required");this._loadSessionFromCookie()};CotSession.LOGIN_CHECK_RESULT_TRUE=1,CotSession.LOGIN_CHECK_RESULT_FALSE=2,CotSession.LOGIN_CHECK_RESULT_INDETERMINATE=3,CotSession.prototype.isLoggedIn=function(o){if(!o)return!!this._cookie("sid")||(this.logout(),!1);var s=this.sid||this._cookie("sid");if(s){var i=this.options.ccApiOrigin+this.options.ccApiPath+this.options.ccApiEndpoint+"/"+s,e=this;$.get(i,function(i){var n=i.app||"",t=i.sid||"",r=i.error||"";n===e.options.appName&&t===s?(e._storeLogin(i),o(CotSession.LOGIN_CHECK_RESULT_TRUE)):"no_such_session"===r?(e.logout(),o(CotSession.LOGIN_CHECK_RESULT_FALSE)):o(CotSession.LOGIN_CHECK_RESULT_INDETERMINATE)}).fail(function(s,i,e){console.log("Unable to test session. jqXHR:",s,"textStatus:",i,"error:",e),o(CotSession.LOGIN_CHECK_RESULT_INDETERMINATE)})}else o(CotSession.LOGIN_CHECK_RESULT_FALSE)},CotSession.prototype.login=function(o){o=$.extend({username:"",password:"",success:function(){},error:function(o,s,i){},always:function(){}},o||{});var s=this.options.ccApiOrigin+this.options.ccApiPath+this.options.ccApiEndpoint+"?app="+this.options.appName,i={user:o.username,pwd:o.password},e=this;$.post(s,i,function(s){s.error?o.error(null,"invalid_user_or_pwd"===s.error?"Invalid username or password":"Login failed",s.error):s.passwordIsExpired?o.error(null,"Expired password","passwordIsExpired"):(e._storeLogin(s),o.success())}).fail(function(s,i,e){o.error(s,i,e)}).always(function(){o.always()})},CotSession.prototype.logout=function(){this._removeCookie("sid"),this._removeCookie("cot_uname"),this._removeCookie("email"),this._removeCookie("firstName"),this._removeCookie("lastName"),this._removeCookie("division"),this._removeCookie("groups"),this._loadSessionFromCookie()},CotSession.prototype.extend=function(o){return!!this.sid&&(this._storeLogin({sessionCookieExpiryDate:o?(new Date).getTime()+60*o*1e3:null,sid:this.sid,userID:this.username||"",email:this.email||"",cotUser:{firstName:this.firstName||"",lastName:this.lastName||"",division:this.division||"",groupMemberships:this.groups||""}}),!0)},CotSession.prototype._loadSessionFromCookie=function(){this.sid=this._cookie("sid")||"",this.username=this._cookie("cot_uname")||"",this.email=this._cookie("email")||"",this.firstName=this._cookie("firstName")||"",this.lastName=this._cookie("lastName")||"",this.division=this._cookie("division")||"",this.groups=this._cookie("groups")||""},CotSession.prototype._storeLogin=function(o){var s=new Date;o.sessionCookieExpiryDate?s.setTime(o.sessionCookieExpiryDate):s.setTime(s.getTime()+18e5),this._cookie("sid",o.sid,{expires:s}),this._cookie("cot_uname",o.userID,{expires:s}),this._cookie("email",(o.email||"").toLowerCase(),{expires:s}),o.cotUser&&(this._cookie("firstName",o.cotUser.firstName,{expires:s}),this._cookie("lastName",o.cotUser.lastName,{expires:s}),this._cookie("division",o.cotUser.division,{expires:s}),this._cookie("groups",o.cotUser.groupMemberships,{expires:s})),this._loadSessionFromCookie()},CotSession.prototype._cookie=function(o,s,i){return o&&(o=encodeURIComponent(this.options.appName)+"."+o),$.cookie(o,s,i)},CotSession.prototype._removeCookie=function(o){return $.removeCookie(encodeURIComponent(this.options.appName)+"."+o)};