/*
Showing a terms and conditions agreement is a common pattern. This helper method encapsulates a common approach

If includeTerms is set to true in your project's package.json coreConfig, then this file will be included.
The method below is a static method of the cot_app (if your app is standalone) or CotApp (if your app is embedded) class.
Use it like this:

CotApp.showTerms({termsText: 'Agree to these terms', disagreedText: 'Why not?', containerSelector: '#my_element'}); //embedded apps

cot_app.showTerms({termsText: 'Agree to these terms', disagreedText: 'Why not?', containerSelector: '#my_element'}); //standalone apps

 */
$(function() {
  function updateCheckbox() {
    if ($('#termsAgree').is(':checked')) {
      $('#termsAgree').closest('.form-group').removeClass('has-error');
      $('#termsAgree').closest('.form-group').addClass('has-success');
      $('#termsAgree_errorMessage small').css('display', 'none');
      $('#termsAgree_errorMessage + .glyphicon').css('display', 'none');
    } else {
      $('#termsAgree').closest('.form-group').addClass('has-error');
      $('#termsAgree').closest('.form-group').removeClass('has-success');
      $('#termsAgree_errorMessage small').css('display', 'block');
      $('#termsAgree_errorMessage + .glyphicon').css('display', 'block');

    }
  }

  var appClass = (window['cot_app'] || window['CotApp']);
  appClass['showTerms'] = function (o) {
    var options = $.extend({
      termsText: 'Content missing: terms text', //The body text of the terms and conditions
      disagreedText: 'You need to agree to the terms to proceed', //The body text to show when someone disagrees with the terms and conditions
      agreedCookieName: 'terms_cookie' + Math.random().toString().split('.')[1], //The name of the cookie to store the user's agreement in
      containerSelector: '', //A CSS selector for an element on screen where the terms and conditions will be shown
      onAgreed: function (termsWereShown) { //A function called after the user clicks the agree button
        //termsWereShown - true if the terms were shown before agreement. false if the user had previously agreed and the cookie was still there, bypassing the terms
      },
      onDisagreed: function () { //A function called after the user clicks the disagree button
      },
      agreementTitle: 'Terms of Use Agreement', //The title to show at the top
      agreeText: 'I HAVE READ AND AGREE TO THE TERMS AND CONDITIONS ABOVE AND TO THE CITY OF TORONTO\'S TERMS OF USE AND PRIVACY POLICY.',
      agreeButton: 'Proceed' //Proceed button label
    }, o);

    if (!options.containerSelector) {
      throw new Error('missing container selector for showTerms');
    }

    if ($.cookie(options.agreedCookieName) !== "agree") {
      $(options.containerSelector).html([
        '<section id="cot-terms">',
          '<form>',
            '<div class="row">',
              '<div class="col-xs-12">',
                '<h2 tabindex="-1">', options.agreementTitle,'</h2>',
                options.termsText,
              '</div>',
            '</div>',
            '<div class="row">',
              '<div class="col-xs-12 ">',
                '<div class="form-group has-feedback">',
                  '<div class="form-control">',
                    '<label>',
                      '<input name="termsAgree" id="termsAgree" aria-required="true" type="checkbox" value="agreed" aria-describedby="termsAgree_errorMessage"> ',
                      '<i class="form-control-feedback glyphicon glyphicon-remove" data-fv-icon-for="termsAgree" aria-hidden="true" style="display: none;"></i>',
                      options.agreeText,
                    '</label>',
                  '</div>',
                  '<div id="termsAgree_errorMessage" class="help-block" role="alert">',
                    '<small class="help-block" style="display: none">',
                      options.disagreedText,
                    '</small>',
                  '</div>',
                '</div>',
              '</div>',
            '</div>',
            '<div class="row">',
              '<div class="col-xs-12">',
                '<div class="btn-group">',
                  '<button type="button" class="btn btn-primary" id="cot-terms-agree">',
                    options.agreeButton,
                  '</button>',
                '</div>',
              '</div>',
            '</div>',
          '</form>',
        '</section>'
      ].join(''));

      $('#termsAgree').click(function() {
        updateCheckbox();
      });

      $("#cot-terms-agree").click(function () {
        updateCheckbox();
        if ($('#termsAgree').is(':checked')) {
          $.cookie(options.agreedCookieName, 'agree', { expires: 1 });
          $('#cot-terms').remove();
          options.onAgreed(true);
        } else {
          options.onDisagreed();
        }
      });
    } else {
      options.onAgreed(false);
    }
  };
});
