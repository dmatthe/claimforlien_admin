<div id="js-customsearch" class="hide">
        <form id="js-search--options">
        <label><input type="radio" name="js-search-type" value="basic" checked> Basic search</label>
        <label><input type="radio" name="js-search-type" value="advanced"> Advanced Search</label>
        <label><input type="radio" name="js-search-type" value="displayall"> Display All Records</label>
        </form>
        <div id="advancedseach"></div>
        </div>


<div id="js-input-fields" class="panel panel-default">
    <h2 class="panel-heading">
        Search for a submitted claim
    </h2>
    <div class="panel-body">
            <p>Please select a Field Name from dropdown list, select a Filter By operator, enter a Search Term and then click Add. Enter as many rows of search criteria as needed by repeating these steps. Click Search.
                </p>
        <form id="queryOptionForm">
            <div id="" class="container-fluid">
                <div class="row" data-option>
                    <div class="col-md-3">
                        <div class="form-group">
                          <label for="fieldId"><b>Field Name (Required)</b></label>
                          <select class="form-control" name="field" id="field">
                                <option disabled="" value="">Select Field Name</option>
                                <!---->
                                <option data-type="both" value="referenceID: LienID" class=""  selected="selected"> Lien ID</option>
                                <option data-type="string" value="claimant_supplied: NameOfClaimant" class=""> Name of Lien Claimant</option>
                                <option data-type="string" value="name_of_lien_claimant: NameOfPerson" class=""> Name of Person Supplied</option>
                                <option data-type="string" value="location_premises: PremisAddress" class=""> Premises Address</option>
                                <option data-type="string" value="description_of_premises: PremisesDescription" class=""> Premises Description</option>
                                <option data-type="string" value="address_for_service: AddressOfService" class=""> Address for Service</option>
                                <option data-type="string" value="name_of_owner: NameOfOwner" class=""> Name of Owner</option>
                                <option data-type="string" value="owner_address: AddressOfOwner" class=""> Address of Owner</option>
                                <option data-type="string" value="9: AddressOfPerson" class=""> Address of Person Supplied</option>
                                <option data-type="date" value="supplied_from: SuppliedFromDate" class=""> Supplied Date From</option>
                                <option data-type="date" value="supplied_to: SuppliedToDate" class=""> Supplied Date To</option>
                                <option data-type="string" value="short_description: ShortDescription" class=""> Short Description</option>
                                <option data-type="string" value="contract_price: ContractPrice" class=""> Contract Price</option>
                                <option data-type="string" value="amount_claimed: AmountClaimed" class=""> Amount Claimed</option>
                                <option data-type="string" value="to_the_claim_for_lien_of: ToClaim" class=""> To the Claim of</option>
                                <option data-type="string" value="contract_number: ContractNumber" class=""> Contract Number</option>
                                <option data-type="string" value="contact_person: OwnerContact" class=""> Owner Contact</option>
                                <option data-type="date" value="__CreatedOn: DateCreated" class=""> Created Date</option>
                                <option data-type="date" value="date: SignatureDate" class=""> Signature Date</option>
                                <option data-type="string" value="signature: Signature" class=""> Signature</option>
                            </select><span class="invalid-feedback"> </span></div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                          <label for="fieldName"><b>Filter By (Required)</b></label>
                          <select class="form-control" name="operation" id="operation">
                                <option disabled=""  value="">Select Filter By</option>
                                <!---->
                                <option data-type="both" value="eq: Equals To"  selected="seleted"  class=""> Equals To</option>
                                <option data-type="both" value="contains: Contains" class=""> Contains</option>
                                <option data-type="both" value="ne: Does Not Equal To" class=""> Does Not Equal To</option>
                                <option data-type="both" value="ge: Greater Than Or Equals To" class=""> Greater Than Or Equals To</option>
                                <option data-type="both" value="le: Less Than Or Equals To" class=""> Less Than Or Equals To</option>
                                <!---->
                                <option data-type="string" value="eq: Equals To" class=""> Equals To</option>
                                <option data-type="string" value="contains: Contains" class=""> Contains</option>
                                <option data-type="string" value="ne: Does Not Equal To" class=""> Does Not Equal To</option>
                                <!---->
                                <option data-type="date" value="eq: Equals To" class=""> Equals To</option>
                                <option data-type="date" value="ge: Greater Than Or Equals To" class=""> Greater Than Or Equals To</option>
                                <option data-type="date" value="le: Less Than Or Equals To" class=""> Less Than Or Equals To</option>
                            </select><span class="invalid-feedback"> </span></div>
                    </div>
                    <!---->
                    <div class="col-md-5">
                        <div class="form-group">
                          <label for="valueId"><b>Search Term (Required)</b></label>
                          <input class="form-control" name="value"
                                id="valueId" type="text" value="32220">
                            <!----><span class="invalid-feedback ng-star-inserted"> Search Term is required </span></div>
                    </div>
                    <!---->
                    <div class="button--add-query" class="col-md-1" style="margin: 1.2em;">
                        <div class="form-group text-center">
                          <button type="button" class="btn" style="cursor: pointer;"><i class="glyphicon glyphicon-plus-sign"
                            style="color:green; font-size: 30px;" title="Add Search Criteria"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <table id="selected-options" class="table">
        <thead>
          <tr>
            <th>Field Name</th>
            <th>Filter By</th>
            <th>Search Term</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
  
        </tbody>
    </table>
    <div class="panel-footer">
      <button id="js-search__button--clear" class="btn btn-lg btn-cancel" type="button">Clear All</button>
      <button id="js-search__button--search" class="btn btn-lg btn-primary" type="button" style="float:right;">Search</button>
    </div>
  </div>
  
  <div id="results"></div>
  
  <script>
    var $queryOptions = document.getElementById('query-options');
    var $selectedOptions = document.getElementById('selected-options');
    var $field = document.getElementById('field');
    var $operation = document.getElementById('operation');
    var queryCount = 0;
    var query = []
    var $search = document.getElementById('js-search__button--search')
    var $clear = document.getElementById('js-search__button--clear')
    var datePicker;
  
    $clear.addEventListener('click',evt=>{
      evt.preventDefault()
  
      $selectedOptions.querySelectorAll('tbody tr').forEach($tr=>{
        $tr.remove();
      })
  
    })
    $search.addEventListener('click',evt=>{
      evt.preventDefault()
      if($selectedOptions.querySelectorAll('tbody tr').length == 0 ) return false;

      var filter = Array.from($selectedOptions.querySelectorAll('tbody tr')).map($tr=>{
        var type = $tr.dataset.type;
        var column = $tr.querySelector('td[data-column]').dataset.column;
        var operation = $tr.querySelector('td[data-operation]').dataset.operation;
        var value = $tr.querySelector('td[data-value]').dataset.value;
  
        if(operation === 'contains'){
          if(type === 'both') return `${column} ${operation} '${value}'`
          if(type === 'string') return `${operation}(${column},'${value}')`;
          if(type === 'date') return `${column} ${operation} '${value}'`
        } else {
          if(type === 'both') return `${column} ${operation} '${value}'`
          if(type === 'string') return `${column} ${operation} '${value}'`;
          if(type === 'date') return `${column} ${operation} '${value}'`
        }
        
  
      }).join(' and ');
  

      $.ajax({
        url:`/c3api_data/v2/DataAccess.svc/claimforlien_admin/submissions?$format=json&$filter=${filter}`,
        method:'GET',
        headers:{
            "Content-Type": 'application/json',
            "Authorization": `AuthSession ${Cookies.get('claimforlien_admin.sid')}`,
        }
      }).then(res=>{
        var $div = document.querySelector('#results');
        $('#js-input-fields').hide();

        $div.innerHTML = `
            <div class="panel panel-default">
                <h2 class="panel-heading">Database Search Results</h2>
                <div class="panel-body">
                    
                </div>
                <table id="js-results-table" class="table table-striped table-bordered table-condensed" style="border-left: none; border-right: none;">
                    <thead>
                        <tr>
                        <th>Lien ID</th>
                        <th>Name of Lien Claimant</th>
                        <th>Name of Owner</th>
                        <th>Amount Claimed</th>
                        <th>Premises Address</th>
                        <th>Short Description</th>
                        <th>Contract Number</th>
                        <th>Created Date</th>
                    </thead>
                    <tbody>
                        
                        ${res.value.map(data=>{
                            return `
                            <tr>
                            <td><a href="/webapps/claimforlien_admin/#submissions/${data.id}">${data.referenceID}</a></td>
                            <td>${data.name_of_lien_claimant}</td>
                            <td>${data.name_of_owner}</td>
                            <td>${data.amount_claimed}</td>
                            <td>${data.location_premises}</td>
                            <td>${data.short_description}</td>
                            <td>${data.contract_number}</td>
                            <td>${data.__CreatedOn}</td>
                            </tr>
                            `
                        }).join('')} 
                        
                    </tbody>
                </table>  
                <div class="panel-footer">
                    <button id="js-search__button--results" class="btn btn-lg btn-default" type="button">Back to Search Options</button>
                </div>
            </div>
            
          `
          
        $('#js-search__button--results').click(evt=>{
            evt.preventDefault();
            $('#results').html('');
            $('#js-input-fields').show();
            
        });

        $('#js-results-table').DataTable({
            autoWidth: false,
            searching: true,
            search:{ search : ''},
            ordering:  true,
            order:[[0, 'asc']],
            paging: true,
            lengthMenu: [[10, 50, -1], [10, 50, 'All']],
            dom: 'B<"#table-header">t<"#table-footer .row" <"col-sm-6"i><"col-sm-6"p>>', /* remove default filters & sorting */
            buttons:[
            {
              extend:'copy',
              exportOptions: {
                modifier: {
                  page: 'all',
                }
              }
            },{
              extend:'excel',
              exportOptions: {
                modifier: {
                  page: 'all',
                }
              }
            },{
              extend:'csvHtml5',
              exportOptions: {
                modifier: {
                  page: 'all',
                }
              }
            },{
              extend:'pdfHtml5',
              pageSize:'LEGAL',
              orientation:'landscape',
              header: true,
              title:'Claim Lien Form 12',
              customize: function(doc){
                doc.styles.tableHeader.fontSize = 10;
                doc.styles.tableHeader.alignment = 'left';
                doc.styles.tableHeader.fillColor = '#165788';
              },
              exportOptions: {
                columns: ':visible',
                modifier: {
                  page: 'all',
                  
                }
              }
            }],
            initComplete: function (settings, json) {

                var info = this.api().page.info();
                TotalItems = info.recordsTotal;

                $('.dt-button').parent().attr('role','group')
                $('.dt-button').parent().prepend('<label style="font-size: 0.8em" aria-hidden="true" class="sr-only">Download the list</label>');
                $('.dt-button').toArray().forEach($btn=>{
                    $($btn).addClass('btn btn-default');
                    $($btn).removeClass('dt-button');
                })
                $('.dt-button .buttons-copy').attr('aria-label','Copy data to clipboard');
                $('.dt-button .buttons-excel').attr('aria-label','Export and download list to an Excel file');
                $('.dt-button .buttons-csv').attr('aria-label','Export and download list to a comma separated file');
                $('.dt-button .buttons-pdf').attr('aria-label','Export and download list to a P.D.F. file');
                
              },
        });
      })
      
      $('#results table tr td a').click(evt=>{
        Cookies.set('claimforlien_admin.lastView=dashboard');
      })
    })
  



    $field.addEventListener('change',evt=>{
      var type = evt.target.selectedOptions[0].dataset.type;
      $('#valueId').val('');

      $('#operation option').hide()
      $('#operation option:first').show()
      $('#operation option').removeAttr('selected')
      $(`#operation [data-type=${type}]:first`).attr('selected','selected')
      $(`#operation [data-type=${type}]`).show();
    
       
      if(type === 'date'){
        $('#valueId').daterangepicker({singleDatePicker:true});
        $('#valueId').on('apply.daterangepicker', function(ev, picker) {
            datePicker = picker;
            //console.log(picker.startDate.format('YYYY-MM-DD'));
            //console.log(picker.endDate.format('YYYY-MM-DD'));
          });
      }
    })

    $operation.addEventListener('change',evt=>{
      value=""
    })
  
  
    document.querySelectorAll('.button--add-query').forEach($btn=>{
      $btn.addEventListener('click',evt=>{
        evt.preventDefault();
        var $formData = $('#queryOptionForm').serializeArray(); 
        query.push($formData)

        var type = $('#field option:selected')[0].dataset.type;
        var columnData = $formData[0].value.split(':')[1].trim();
        var operationData = $formData[1].value.split(':')[1].trim()
        var valueData = (type=='date')?moment($formData[2].value).format('YYYY-MM-DDTHH:MM'):$formData[2].value.trim();
        
  
        var $row = `<tr data-type="string" id="queryCount${queryCount}">`;
            $row += `<td data-column="${$formData[0].value.split(':')[0].trim()}">${ columnData }</td>`;
            $row += `<td data-operation="${$formData[1].value.split(':')[0].trim()}">${ operationData }</td>`;
            $row += `<td data-value="${valueData}">${ valueData }</td>`;
            $row += `
            <td>
               <button data-target="queryCount${queryCount}" class="btn" type="button" style="cursor: pointer;">
                    <i class="glyphicon glyphicon-remove-sign btn-cancel" style="font-size: 20px;" title="Remove Search Criteria"></i>
                </button>
            </td>`
            $row += '</tr>'

        $($selectedOptions,'tbody').append($row);
        $($selectedOptions,'button').click(evt=>{
          evt.preventDefault();
          var target = evt.target.parentElement.dataset.target;
          var ndx = target.split('queryCount')[1];
          $(`#${target}`).remove();
        });
  
        queryCount++;
      })
    })
  
  </script>